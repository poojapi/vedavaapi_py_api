{% extends "base.html" %}
<script src="/static/js/shapes.js" type="text/javascript"></script>
{% block content %}

<script type="text/javascript">
    var bpath = '{{ bookpath }}';
    {% if curpageidx %}
    var curpage = {{ curpageidx }};
    {% else %}
    var curpage = 1;
    {% endif %}
</script>

<div id="leftcol">
    <button onclick="saveData()">Save</button>
    <button onclick="zoomIn()">ZoomIn</button>
    <button onclick="zoomOut()">ZoomOut</button>
    <span id='scale'> </span> 
    <input id="bookdetails" type="hidden">
    <input id="curpage" type="hidden">
    <div id="bookidx"></div>
</div>

<div id="content">
    <input id="page_annotations" type="hidden">
    <input id="page_sections" type="hidden">
    <div id='container' style="float:left; overflow:auto;">
    <canvas id="canvas1"> </canvas>
    </div>
</div>

<script type="text/javascript" src="{{ url_for('static', filename='js/shapes.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/pramukhime.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/pramukhindic.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/CanvasInput.js') }}"></script>

<script type="text/javascript">

//var canvas = document.getElementById('canvas1');
var container = document.getElementById('container');
//container.appendChild(canvas);
//var context = canvas.getContext('2d');

window.cState = undefined;
var curpage_annotations = {};
var curpage_sections = {};
getbook(true, bpath);

pramukhIME.addLanguage(PramukhIndic,"sanskrit");
pramukhIME.enable();

function saveData() {
    window.cState.saveShapes();
}

function zoomIn() {
    window.cState.zoomIn();
    document.getElementById("scale").innerHTML = parseFloat(window.cState.scale).toFixed(1);
}

function zoomOut() {
    window.cState.zoomOut();
    document.getElementById("scale").innerHTML = parseFloat(window.cState.scale).toFixed(1);
}

function loadpage() {
    var curpage = $('#curpage').val();
    if (curpage == undefined)
        return;
    console.log("Loading page " + curpage);
    var details = $('#bookdetails').val();
    var bookdetails = JSON.parse(details);
    var pagedetails = bookdetails['pages'][curpage];
    console.log(pagedetails);
    pgname = pagedetails['fname'];
    var fpath = bpath + "/" + pgname;
    console.log("Loading page path: " + fpath);
    var anno_id = pagedetails['anno'];
    var sec_id = pagedetails['sections'];

    $.getJSON('/books/page/anno/'+anno_id, function(data){
        if (! mychkstatus(data))
            return;
        curpage_annotations = data.result;
        window.cState = init('canvas1','/books/page/image/'+fpath, 
            curpage_annotations['anno'], anno_id);
        console.log(window.cState);
    });

    $.getJSON('/books/page/sections?id='+sec_id, function(data){
        if (! mychkstatus(data))
            return;
        curpage_sections = data;
    });
}

$(document).ready(function () {
    $('#curpage').change(function() {
        loadpage();
    });
});

document.onkeydown = function (e) {
    e = e || window.event;//Get event
    if (e.ctrlKey) {
        var c = e.which || e.keyCode;//Get key code
        switch (c) {
            case 83://Block Ctrl+S
                saveData();
                e.preventDefault();     
                e.stopPropagation();
            break;
        }
    }
};

</script>

{% endblock %}

